name: Rewardsy Comprehensive Health Checks - All Services

on:
  schedule:
    # Runs every 10 minutes
    - cron: '*/10 * * * *'
    # Daily summary at 9 AM IST (3:30 AM UTC)
    - cron: '30 3 * * *'
  workflow_dispatch:

env:
  # ========================================
  # INGRESS ENDPOINTS (via NGINX - Primary)
  # ========================================
  REWARDSY_BACKEND_URL: https://app.rewardsy.one/rewardsy-backend
  REWARDSY_WEBAPP_URL: https://app.rewardsy.one
  REWARDSY_MERCHANT_URL: https://merchant.rewardsy.one
  REWARDSY_DATA_URL: https://app.rewardsy.one/rewardsy-data
  REWARDSY_SUPRPIXL_URL: https://suprpixl.rewardsy.one
  KIBANA_URL: https://app.rewardsy.one/kibana
  KAFKA_UI_URL: https://app.rewardsy.one/kafka-ui
  
  # ========================================
  # LOADBALANCER IPs (Direct Access - Fallback)
  # ========================================
  INGRESS_NGINX_IP: http://52.140.85.8
  KIBANA_LB_IP: http://98.70.242.255
  DATA_SERVICE_LB_IP: http://4.213.202.43
  MERCHANT_SERVICE_LB_IP: http://135.235.254.253
  WEBAPP_SERVICE_LB_IP: http://4.186.15.176
  SUPRPIXL_SERVICE_LB_IP: http://4.187.129.223
  KAFKA_BROKER_IP: http://4.187.131.231
  KAFKA_EXTERNAL_IP: http://4.187.250.117
  
  # ========================================
  # AZURE AKS CONFIGURATION
  # ========================================
  AKS_CLUSTER_NAME: rewardsy-prod-aks
  AKS_RESOURCE_GROUP: rewardsy-prod-rg
  
  # ========================================
  # DISCORD NOTIFICATION
  # ========================================
  DISCORD_WEBHOOK: https://discord.com/api/webhooks/1391803646500671588/7_zWESR3N1FtkNIu-vsAKdicx8JTjdlBYW0WPLvkr7VK3IaRRefqy2zW7eqEwoDqF5Cx

jobs:
  # ================================================================
  # KUBERNETES CLUSTER HEALTH
  # ================================================================
  
  kubernetes-pod-health:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.pod_check.outcome }}
      total_pods: ${{ steps.pod_check.outputs.total_pods }}
      problematic_pods: ${{ steps.pod_check.outputs.problematic_pods }}
      problem_count: ${{ steps.pod_check.outputs.problem_count }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set AKS context
        uses: azure/aks-set-context@v3
        with:
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
      
      - name: Check pod health across application namespaces
        id: pod_check
        continue-on-error: true
        run: |
          # Application namespaces to monitor
          NAMESPACES="rewardsy-backend rewardsy-webapp rewardsy-data rewardsy-merchant rewardsy-suprpixl kafka ingress-nginx"
          
          problematic_pods=""
          total_pods=0
          problem_count=0
          
          echo "ğŸ” Checking pods in application namespaces..."
          
          for ns in $NAMESPACES; do
            echo "Namespace: $ns"
            
            # Get total pods in namespace
            ns_pod_count=$(kubectl get pods -n $ns --no-headers 2>/dev/null | wc -l || echo "0")
            total_pods=$((total_pods + ns_pod_count))
            
            # Get pods not in Running or Succeeded state
            non_running=$(kubectl get pods -n $ns --field-selector=status.phase!=Running,status.phase!=Succeeded --no-headers 2>/dev/null || echo "")
            
            if [ -n "$non_running" ]; then
              while IFS= read -r line; do
                pod_name=$(echo "$line" | awk '{print $1}')
                status=$(echo "$line" | awk '{print $3}')
                problematic_pods="${problematic_pods}${ns}/${pod_name} [${status}]"$'\n'
                problem_count=$((problem_count + 1))
              done <<< "$non_running"
            fi
          done
          
          echo "total_pods=$total_pods" >> $GITHUB_OUTPUT
          echo "problem_count=$problem_count" >> $GITHUB_OUTPUT
          
          if [ -n "$problematic_pods" ]; then
            echo "problematic_pods<<EOF" >> $GITHUB_OUTPUT
            echo "$problematic_pods" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "problematic_pods=None" >> $GITHUB_OUTPUT
          fi
          
          if [ $problem_count -gt 0 ]; then
            echo "âŒ Found $problem_count problematic pods out of $total_pods total"
            exit 1
          else
            echo "âœ… All $total_pods application pods are healthy"
          fi

  kubernetes-node-health:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.node_check.outcome }}
      node_count: ${{ steps.node_check.outputs.node_count }}
      notready_nodes: ${{ steps.node_check.outputs.notready_nodes }}
      avg_cpu: ${{ steps.node_check.outputs.avg_cpu }}
      avg_memory: ${{ steps.node_check.outputs.avg_memory }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set AKS context
        uses: azure/aks-set-context@v3
        with:
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
      
      - name: Check node health and utilization
        id: node_check
        continue-on-error: true
        run: |
          # Get node status
          notready_nodes=$(kubectl get nodes --no-headers | grep -v "Ready" | awk '{print $1}' || echo "")
          total_nodes=$(kubectl get nodes --no-headers | wc -l)
          
          echo "node_count=$total_nodes" >> $GITHUB_OUTPUT
          
          # Get node metrics
          if kubectl top nodes &>/dev/null; then
            node_metrics=$(kubectl top nodes --no-headers)
            
            # Calculate average CPU and Memory
            avg_cpu=$(echo "$node_metrics" | awk '{gsub(/%/,"",$3); sum+=$3} END {printf "%.0f%%", sum/NR}')
            avg_memory=$(echo "$node_metrics" | awk '{gsub(/%/,"",$5); sum+=$5} END {printf "%.0f%%", sum/NR}')
            
            echo "avg_cpu=$avg_cpu" >> $GITHUB_OUTPUT
            echo "avg_memory=$avg_memory" >> $GITHUB_OUTPUT
          else
            echo "avg_cpu=N/A" >> $GITHUB_OUTPUT
            echo "avg_memory=N/A" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$notready_nodes" ]; then
            echo "notready_nodes=$notready_nodes" >> $GITHUB_OUTPUT
            echo "âŒ Found NotReady nodes: $notready_nodes"
            exit 1
          else
            echo "notready_nodes=None" >> $GITHUB_OUTPUT
            echo "âœ… All $total_nodes nodes are Ready"
          fi

  # ================================================================
  # APPLICATION SERVICE HEALTH CHECKS
  # ================================================================

  rewardsy-backend-health:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.health_check.outcome }}
      response_code: ${{ steps.health_check.outputs.response_code }}
      response_time: ${{ steps.health_check.outputs.response_time }}
    steps:
      - name: Check backend health
        id: health_check
        continue-on-error: true
        run: |
          start_time=$(date +%s%N)
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ env.REWARDSY_BACKEND_URL }}/docs/core)
          end_time=$(date +%s%N)
          response_time=$(( (end_time - start_time) / 1000000 ))
          
          echo "response_code=$response" >> $GITHUB_OUTPUT
          echo "response_time=${response_time}ms" >> $GITHUB_OUTPUT
          
          if [ "$response" -ne 200 ]; then
            echo "âŒ Backend health check failed! HTTP: $response"
            exit 1
          else
            echo "âœ… Backend healthy (${response_time}ms)"
          fi

  rewardsy-webapp-health:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.health_check.outcome }}
      response_code: ${{ steps.health_check.outputs.response_code }}
      response_time: ${{ steps.health_check.outputs.response_time }}
    steps:
      - name: Check webapp health
        id: health_check
        continue-on-error: true
        run: |
          start_time=$(date +%s%N)
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ env.REWARDSY_WEBAPP_URL }})
          end_time=$(date +%s%N)
          response_time=$(( (end_time - start_time) / 1000000 ))
          
          echo "response_code=$response" >> $GITHUB_OUTPUT
          echo "response_time=${response_time}ms" >> $GITHUB_OUTPUT
          
          if [ "$response" -ne 200 ]; then
            echo "âŒ WebApp health check failed! HTTP: $response"
            exit 1
          else
            echo "âœ… WebApp healthy (${response_time}ms)"
          fi

  rewardsy-merchant-health:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.health_check.outcome }}
      response_code: ${{ steps.health_check.outputs.response_code }}
      response_time: ${{ steps.health_check.outputs.response_time }}
    steps:
      - name: Check merchant service health
        id: health_check
        continue-on-error: true
        run: |
          start_time=$(date +%s%N)
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ env.REWARDSY_MERCHANT_URL }} || echo "000")
          end_time=$(date +%s%N)
          response_time=$(( (end_time - start_time) / 1000000 ))
          
          echo "response_code=$response" >> $GITHUB_OUTPUT
          echo "response_time=${response_time}ms" >> $GITHUB_OUTPUT
          
          if [ "$response" != "200" ] && [ "$response" != "302" ] && [ "$response" != "404" ]; then
            echo "âŒ Merchant service health check failed! HTTP: $response"
            exit 1
          else
            echo "âœ… Merchant service healthy (${response_time}ms)"
          fi

  rewardsy-data-health:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.health_check.outcome }}
      response_code: ${{ steps.health_check.outputs.response_code }}
    steps:
      - name: Check data service health
        id: health_check
        continue-on-error: true
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ env.REWARDSY_DATA_URL }}/health || echo "000")
          
          if [ "$response" = "000" ] || [ "$response" = "404" ]; then
            echo "Trying direct LoadBalancer IP..."
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ env.DATA_SERVICE_LB_IP }}/health || echo "000")
          fi
          
          echo "response_code=$response" >> $GITHUB_OUTPUT
          
          if [ "$response" != "200" ] && [ "$response" != "404" ]; then
            echo "âŒ Data service health check failed! HTTP: $response"
            exit 1
          else
            echo "âœ… Data service healthy"
          fi

  rewardsy-suprpixl-health:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.health_check.outcome }}
      response_code: ${{ steps.health_check.outputs.response_code }}
      response_time: ${{ steps.health_check.outputs.response_time }}
    steps:
      - name: Check SuprPixl service health
        id: health_check
        continue-on-error: true
        run: |
          start_time=$(date +%s%N)
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ env.REWARDSY_SUPRPIXL_URL }} || echo "000")
          end_time=$(date +%s%N)
          response_time=$(( (end_time - start_time) / 1000000 ))
          
          if [ "$response" = "000" ]; then
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ env.SUPRPIXL_SERVICE_LB_IP }} || echo "000")
          fi
          
          echo "response_code=$response" >> $GITHUB_OUTPUT
          echo "response_time=${response_time}ms" >> $GITHUB_OUTPUT
          
          if [ "$response" != "200" ] && [ "$response" != "302" ] && [ "$response" != "404" ]; then
            echo "âŒ SuprPixl service health check failed! HTTP: $response"
            exit 1
          else
            echo "âœ… SuprPixl service healthy (${response_time}ms)"
          fi

  kibana-health:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.health_check.outcome }}
      response_code: ${{ steps.health_check.outputs.response_code }}
    steps:
      - name: Check Kibana health
        id: health_check
        continue-on-error: true
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ env.KIBANA_URL }}/app/home || echo "000")
          
          echo "response_code=$response" >> $GITHUB_OUTPUT
          
          if [ "$response" != "200" ] && [ "$response" != "302" ]; then
            echo "âŒ Kibana health check failed! HTTP: $response"
            exit 1
          else
            echo "âœ… Kibana healthy"
          fi

  kafka-ui-health:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.health_check.outcome }}
      response_code: ${{ steps.health_check.outputs.response_code }}
    steps:
      - name: Check Kafka UI health
        id: health_check
        continue-on-error: true
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ env.KAFKA_UI_URL }} || echo "000")
          
          echo "response_code=$response" >> $GITHUB_OUTPUT
          
          if [ "$response" != "200" ]; then
            echo "âŒ Kafka UI health check failed! HTTP: $response"
            exit 1
          else
            echo "âœ… Kafka UI healthy"
          fi

  ingress-nginx-health:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.health_check.outcome }}
    steps:
      - name: Check Ingress NGINX health
        id: health_check
        continue-on-error: true
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ env.INGRESS_NGINX_IP }}/healthz || echo "000")
          
          if [ "$response" != "200" ] && [ "$response" != "404" ]; then
            echo "âš ï¸ Ingress NGINX health check warning! HTTP: $response"
            exit 1
          else
            echo "âœ… Ingress NGINX operational"
          fi

  # ================================================================
  # AGGREGATE RESULTS & SEND NOTIFICATIONS
  # ================================================================
  
  aggregate-and-notify:
    runs-on: ubuntu-latest
    needs: 
      - kubernetes-pod-health
      - kubernetes-node-health
      - rewardsy-backend-health
      - rewardsy-webapp-health
      - rewardsy-merchant-health
      - rewardsy-data-health
      - rewardsy-suprpixl-health
      - kibana-health
      - kafka-ui-health
      - ingress-nginx-health
    if: always()
    
    steps:
      - name: Calculate overall health status
        id: summary
        run: |
          # Count total checks and failures
          total_checks=10
          failed_checks=0
          
          # Check each service status (handle empty outputs) - use || true to prevent exit on error
          [[ "${{ needs.kubernetes-pod-health.outputs.status }}" == "failure" ]] && ((failed_checks++)) || true
          [[ "${{ needs.kubernetes-node-health.outputs.status }}" == "failure" ]] && ((failed_checks++)) || true
          [[ "${{ needs.rewardsy-backend-health.outputs.status }}" == "failure" ]] && ((failed_checks++)) || true
          [[ "${{ needs.rewardsy-webapp-health.outputs.status }}" == "failure" ]] && ((failed_checks++)) || true
          [[ "${{ needs.rewardsy-merchant-health.outputs.status }}" == "failure" ]] && ((failed_checks++)) || true
          [[ "${{ needs.rewardsy-data-health.outputs.status }}" == "failure" ]] && ((failed_checks++)) || true
          [[ "${{ needs.rewardsy-suprpixl-health.outputs.status }}" == "failure" ]] && ((failed_checks++)) || true
          [[ "${{ needs.kibana-health.outputs.status }}" == "failure" ]] && ((failed_checks++)) || true
          [[ "${{ needs.kafka-ui-health.outputs.status }}" == "failure" ]] && ((failed_checks++)) || true
          [[ "${{ needs.ingress-nginx-health.outputs.status }}" == "failure" ]] && ((failed_checks++)) || true
          
          echo "failed_checks=$failed_checks" >> $GITHUB_OUTPUT
          echo "total_checks=$total_checks" >> $GITHUB_OUTPUT
          
          # Determine severity level
          if [ $failed_checks -eq 0 ]; then
            echo "severity=healthy" >> $GITHUB_OUTPUT
            echo "color=3066993" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          elif [ $failed_checks -le 2 ]; then
            echo "severity=warning" >> $GITHUB_OUTPUT
            echo "color=16776960" >> $GITHUB_OUTPUT
            echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
          else
            echo "severity=critical" >> $GITHUB_OUTPUT
            echo "color=15158332" >> $GITHUB_OUTPUT
            echo "emoji=ğŸ”´" >> $GITHUB_OUTPUT
          fi

      - name: Send alert notification (failures only)
        if: steps.summary.outputs.failed_checks != '0'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ env.DISCORD_WEBHOOK }}
          nodetail: true
          title: "${{ steps.summary.outputs.emoji }} HEALTH ALERT - ${{ steps.summary.outputs.failed_checks }}/${{ steps.summary.outputs.total_checks }} Services Down"
          description: |
            @everyone **IMMEDIATE ATTENTION REQUIRED**
            
            **ğŸ—ï¸ Infrastructure Health:**
            ${{ needs.kubernetes-node-health.outputs.status == 'failure' && 'ğŸ”´' || 'âœ…' }} AKS Nodes - ${{ needs.kubernetes-node-health.outputs.node_count || 'N/A' }} nodes (CPU: ${{ needs.kubernetes-node-health.outputs.avg_cpu || 'N/A' }}, Memory: ${{ needs.kubernetes-node-health.outputs.avg_memory || 'N/A' }})
            ${{ needs.kubernetes-pod-health.outputs.status == 'failure' && 'ğŸ”´' || 'âœ…' }} Kubernetes Pods - ${{ needs.kubernetes-pod-health.outputs.total_pods || 'N/A' }} total pods
            
            **ğŸš€ Application Services:**
            ${{ needs.rewardsy-backend-health.outputs.status == 'failure' && 'ğŸ”´' || 'âœ…' }} Backend - [${{ needs.rewardsy-backend-health.outputs.response_code || 'N/A' }}] (${{ needs.rewardsy-backend-health.outputs.response_time || 'N/A' }})
            ${{ needs.rewardsy-webapp-health.outputs.status == 'failure' && 'ğŸ”´' || 'âœ…' }} WebApp - [${{ needs.rewardsy-webapp-health.outputs.response_code || 'N/A' }}] (${{ needs.rewardsy-webapp-health.outputs.response_time || 'N/A' }})
            ${{ needs.rewardsy-merchant-health.outputs.status == 'failure' && 'ğŸ”´' || 'âœ…' }} Merchant - [${{ needs.rewardsy-merchant-health.outputs.response_code || 'N/A' }}] (${{ needs.rewardsy-merchant-health.outputs.response_time || 'N/A' }})
            ${{ needs.rewardsy-data-health.outputs.status == 'failure' && 'ğŸ”´' || 'âœ…' }} Data Service - [${{ needs.rewardsy-data-health.outputs.response_code || 'N/A' }}]
            ${{ needs.rewardsy-suprpixl-health.outputs.status == 'failure' && 'ğŸ”´' || 'âœ…' }} SuprPixl - [${{ needs.rewardsy-suprpixl-health.outputs.response_code || 'N/A' }}] (${{ needs.rewardsy-suprpixl-health.outputs.response_time || 'N/A' }})
            
            **ğŸ”§ Supporting Services:**
            ${{ needs.kibana-health.outputs.status == 'failure' && 'ğŸ”´' || 'âœ…' }} Kibana - [${{ needs.kibana-health.outputs.response_code || 'N/A' }}]
            ${{ needs.kafka-ui-health.outputs.status == 'failure' && 'ğŸ”´' || 'âœ…' }} Kafka UI - [${{ needs.kafka-ui-health.outputs.response_code || 'N/A' }}]
            ${{ needs.ingress-nginx-health.outputs.status == 'failure' && 'ğŸ”´' || 'âœ…' }} Ingress NGINX
            
            ${{ needs.kubernetes-pod-health.outputs.problem_count != '0' && needs.kubernetes-pod-health.outputs.problem_count != '' && format('**âš ï¸ Problematic Pods ({0}):**\n```\n{1}\n```', needs.kubernetes-pod-health.outputs.problem_count, needs.kubernetes-pod-health.outputs.problematic_pods) || '' }}
            
            **ğŸ”— Actions:**
            [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            [Azure Portal](https://portal.azure.com/#@rewardsy.com/resource/subscriptions/4b9e0373-83d3-42e8-95f9-be6625019af0/resourceGroups/rewardsy-prod-rg/providers/Microsoft.ContainerService/managedClusters/rewardsy-prod-aks/workloads)
          color: ${{ steps.summary.outputs.color }}
          username: Rewardsy Health Monitor
          avatar_url: https://cdn-icons-png.flaticon.com/512/2917/2917995.png

      - name: Send daily health summary
        if: steps.summary.outputs.failed_checks == '0' && github.event.schedule == '30 3 * * *'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ env.DISCORD_WEBHOOK }}
          nodetail: true
          title: "âœ… Daily Health Report - All Systems Operational"
          description: |
            **ğŸ“Š Rewardsy Production Environment - Healthy**
            
            **Infrastructure:**
            âœ… AKS Nodes: ${{ needs.kubernetes-node-health.outputs.node_count || 'N/A' }} (CPU: ${{ needs.kubernetes-node-health.outputs.avg_cpu || 'N/A' }}, Memory: ${{ needs.kubernetes-node-health.outputs.avg_memory || 'N/A' }})
            âœ… Application Pods: ${{ needs.kubernetes-pod-health.outputs.total_pods || 'N/A' }}
            
            **Application Services:**
            âœ… Backend (${{ needs.rewardsy-backend-health.outputs.response_time || 'N/A' }})
            âœ… WebApp (${{ needs.rewardsy-webapp-health.outputs.response_time || 'N/A' }})
            âœ… Merchant (${{ needs.rewardsy-merchant-health.outputs.response_time || 'N/A' }})
            âœ… Data Service
            âœ… SuprPixl (${{ needs.rewardsy-suprpixl-health.outputs.response_time || 'N/A' }})
            
            **Supporting Services:**
            âœ… Kibana
            âœ… Kafka UI
            âœ… Ingress NGINX
            
            *Next health check in 10 minutes*
          color: 3066993
          username: Rewardsy Health Monitor
          avatar_url: https://cdn-icons-png.flaticon.com/512/2917/2917995.png
